<!DOCTYPE html>
<html lang="en">

<head>
    <title></title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <meta name="robots" content="noodp"/>

    <link rel="stylesheet" href="https://chux0519.github.io/style.css">
    <link rel="stylesheet" href="https://chux0519.github.io/color/hexyoungs.css">

    <link rel="stylesheet" href="https://chux0519.github.io/font-hack-subset.css">
<link rel="alternate" type="application/rss+xml" title="RSS" href="https://chux0519.github.io/rss.xml">


        <link rel="shortcut icon" type="image&#x2F;png" href="/favicon.png">
    
    </head>

<body class="">
<div class="container">
    
    <header class="header">
        <div class="header__inner">
            <div class="header__logo">
                    
                <a href="https://chux0519.github.io" style="text-decoration: none;">
                    <div class="logo">
                            chux0519
                        </div>
                </a>
            </div>
        </div>

        <nav class="menu">
            <ul class="menu__inner">
                <li><a href="https://chux0519.github.io">main</a></li>
            
                <li class="active"><a href="https://chux0519.github.io/blog">blog</a></li>
            
                <li><a href="https://chux0519.github.io/projects">projects</a></li>
            
                <li><a href="https://github.com/chux0519" target="_blank" rel="noopener noreferrer">github</a></li>
            </ul>
        </nav>
    
    </header>
    

    <div class="content">
        
    <div class="post">
        
    <h1 class="post-title"><a href="https://chux0519.github.io/blog/io-uring-00/">io_uring 简介</a></h1>
    <div class="post-meta-inline">
        
    <span class="post-date">
            2021-10-10
        </span>

    </div>

    

        
        <div class="post-content">
            <h2 id="shen-me-shi-io-uring">什么是 io_uring</h2>
<p>它是 Linux 下的，新的异步 IO 的 API，由 Facebook 工程师 Jens Axboe created 出来。</p>
<h3 id="yi-you-jie-jue-fang-an-de-ju-xian">已有解决方案的局限</h3>
<p>aio 是 Linux 中已有的异步 IO 系统调用，支持文件和 socket，但是有一些局限</p>
<ol>
<li>只支持 O_DIRECT 模式的读写，这是最大的局限性，而现实世界中，几乎没有应用有这种常规性质需求</li>
<li>即使在 O_DIRECT 下，aio 也可能因为 metadata 缺失导致 block</li>
<li>某些存储设备有固定的请求队列大小( slots for request，个人理解类似 socket 的 backlog)，队列满时，aio 的提交也会 block</li>
<li>提交和完成过程，会有 104 字节的额外拷贝开销，提交和完成也会产生两个不同的系统调用</li>
</ol>
<span id="continue-reading"></span><h3 id="xin-zhi-mo-xing-mental">心智模型 (mental)</h3>
<p>io_uring 的名字就暗示了，kernel-user 之间主要通过 ring buffer 来进行交流，里面包含了一些系统调用，设计时尽可能地保持精简，并且提供一种可用的 polling 模式，来尽量减少这些系统调用。</p>
<ol>
<li>存在 2 个 ring buffer，一个为提交队列 (submission queue，后简称 SQ) 服务，一个为完成队列 (completion queue，后简称 CQ) 服务</li>
<li>ring buffer 同时被 user 和 kernel space 共享，通过调用 <code>io_uring_setup()</code> 然后通过 <code>mmap(2)</code> 映射共享</li>
<li>用户告诉 <code>io_uring</code> 要做些什么 (比如读写文件，accept 连接等)，被描述的结构叫做 submission queue entry (后面简称 SQE)，它将会被添加到 SQ ring buffer 的尾部</li>
<li>然后用户进行 <code>io_uring_enter()</code> 系统调用，让 io_uring 工作</li>
<li><code>io_uring_enter()</code> 提供可选功能，可以在返回前，等待其他的用户请求被处理，意味着用户可以一次性读取所有被处理后的结果</li>
<li>kernel 处理用户提交的这些请求，然后添加到 CQ 的 ring buffer 的尾部，被处理完成的请求叫做 completion queue events (CQEs)</li>
<li>用户从 CQ 的 ring buffer 中读取 CQEs，每个 CQE 都对应了一个 SQE，并且包含了对应的状态</li>
<li>用户根据需求继续这个 <code>添加 SQE</code> - <code>读取 CQE</code> 的流程</li>
<li>用户还可以使用 polling 模式，让 kernel 自己去轮询新的 SQE，可以避免多次手动调用 <code>io_uring_enter()</code> 的开销</li>
</ol>
<h3 id="xing-neng">性能</h3>
<p>性能提升主要来自于 ring buffer，它不会产生 kernel-user space 之间的数据拷贝。而这些数据拷贝往往需要很多系统调用，系统调用的花销比较大，因此减少系统调用，也就削减了花销，也就提升了性能</p>
<p>另一方面，polling 模式可以减少 <code>io_uring_enter()</code> 的开销，这是之前 aio 没有的。</p>
<p>性能的 benchmark 可以参考 <a href="https://kernel.dk/io_uring.pdf">io_uring.pdf</a>，也可以去网上寻找其他真实世界的案例</p>
<h3 id="jie-kou">接口</h3>
<p>请直接使用 liburing，它做了底层 API 的封装，有丰富的测试，并且也被 QEMU 用上了</p>
<p>不过了解 io_uring 本身的一些系统调用是非常有帮助也是有必要的，这一节将放在下一部分完成。</p>
<h2 id="zi-yuan">资源</h2>
<ul>
<li><a href="https://unixism.net/loti/index.html">Lord of the io_uring</a></li>
</ul>

        </div>

        
    </div>

    </div>

    
    <footer class="footer">
        <div class="footer__inner">
                <div class="copyright copyright--user">&copy; Copyright 2024 by&nbsp<a href="https://chux0519.github.io">chux0519</a>.</div>
            </div>
    </footer>
    

</div>
</body>

</html>
